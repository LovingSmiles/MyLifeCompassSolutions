<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LovingSmiles — Sign In</title>
<link rel="stylesheet" href="styles.css" />
<style>
  body{background:#f7f8fb}
  .auth-wrap{max-width:900px;margin:40px auto;display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:960px){.auth-wrap{grid-template-columns:1.1fr .9fr}}
  .brand{font-weight:800}
  .card h3{margin:.2rem 0}
  .muted{color:#667}
  .link{color:#2563eb;cursor:pointer}
  .row{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}}
  .pw-meter{height:6px;border-radius:6px;background:#e5e7eb;overflow:hidden}
  .pw-meter > div{height:100%;width:0;transition:width .25s}
  .success{background:#16a34a}.warn{background:#f59e0b}.danger{background:#ef4444}
  .center{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<header class="site-header">
  <div class="wrap center" style="justify-content:space-between">
    <div class="brand">Life Compass Pro — LovingSmiles</div>
    <div><a class="link" href="aihelper.html">AI Helpers</a></div>
  </div>
</header>

<main class="auth-wrap">
  <!-- LEFT: Create Account -->
  <section class="card">
    <h3>Create Account</h3>
    <p class="muted">Start your journey. We’ll store this locally unless you later enable cloud sync.</p>
    <div class="row row-2">
      <label>First name <input id="r_first" required></label>
      <label>Last name <input id="r_last" required></label>
      <label>Email <input id="r_email" type="email" placeholder="you@example.com" required></label>
      <label>Date of birth <input id="r_dob" type="date" required></label>
      <label>City/Region <input id="r_place" placeholder="e.g., Boise, ID"></label>
      <label>Country <input id="r_country" placeholder="e.g., USA"></label>
      <label>Password <input id="r_pw1" type="password" required></label>
      <label>Confirm password <input id="r_pw2" type="password" required></label>
      <div class="row" style="grid-column:1/-1">
        <div class="pw-meter"><div id="pwbar"></div></div>
        <small id="pwmsg" class="muted"></small>
      </div>
      <label>Security question
        <select id="r_q1">
          <option>Where were you born?</option>
          <option>What was your first pet’s name?</option>
          <option>What is your favorite teacher’s last name?</option>
          <option>What city did you get married in?</option>
          <option>Custom (type below)</option>
        </select>
      </label>
      <label>Custom question (optional) <input id="r_q1c" placeholder="If you chose Custom"></label>
      <label>Answer <input id="r_a1" type="password" placeholder="Answer (case-sensitive)" required></label>
      <label class="center" style="grid-column:1/-1">
        <input id="r_terms" type="checkbox"> I agree to the local-only terms for now (no cloud).
      </label>
    </div>
    <div class="center">
      <label class="center"><input id="r_show" type="checkbox"> Show passwords</label>
    </div>
    <button id="btn_register" class="btn btn-success mt-2">Create Account</button>
    <div id="r_status" class="muted mt-1"></div>
  </section>

  <!-- RIGHT: Sign In / Forgot -->
  <section class="card">
    <h3>Sign In</h3>
    <div class="row">
      <label>Email <input id="l_email" type="email" required></label>
      <label>Password <input id="l_pw" type="password" required></label>
      <div class="center">
        <label class="center"><input id="l_show" type="checkbox"> Show password</label>
        <label class="center"><input id="l_rem" type="checkbox"> Remember me</label>
      </div>
      <button id="btn_login" class="btn btn-primary">Sign In</button>
      <small class="muted">Forgot your password? <span id="link_forgot" class="link">Recover it</span></small>
      <div id="l_status" class="muted"></div>
    </div>

    <hr class="mt-2 mb-2">

    <h3>Forgot Password</h3>
    <div class="row">
      <label>Email <input id="f_email" type="email"></label>
      <button id="btn_fq" class="btn btn-ghost">Show my security question</button>
      <div id="fq_box" style="display:none">
        <p id="fq_text" class="muted"></p>
        <label>Answer <input id="fq_answer" type="password"></label>
        <label>New password <input id="fq_new1" type="password"></label>
        <label>Confirm new password <input id="fq_new2" type="password"></label>
        <button id="btn_reset" class="btn btn-success">Set New Password</button>
      </div>
      <div id="f_status" class="muted"></div>
    </div>
  </section>
</main>

<footer class="wrap center" style="justify-content:center">
  <p>© 2025 LovingSmiles • Privacy-first. Works offline. </p>
</footer>

<script>
/*** Storage Keys ***/
const USERS_K = 'lc_users_v1';       // email -> user record
const SESS_K  = 'lc_session_v1';     // current session token
const FAILS_K = 'lc_login_fails_v1'; // email -> count
const LOCK_K  = 'lc_login_lock_v1';  // email -> until timestamp

/*** Small helpers ***/
const $=s=>document.querySelector(s);
const read=(k,fb)=>{try{return JSON.parse(localStorage.getItem(k))??fb}catch{return fb}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const now=()=>Date.now();
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

/*** Hash (SHA-256) for passwords/answers ***/
async function hash(str){
  const enc=new TextEncoder().encode(str);
  const buf=await crypto.subtle.digest('SHA-256',enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

/*** Password UI strength ***/
function pwStrength(pw){
  let s=0;
  if(pw.length>=8) s++;
  if(/[A-Z]/.test(pw)) s++;
  if(/[a-z]/.test(pw)) s++;
  if(/\d/.test(pw)) s++;
  if(/[^A-Za-z0-9]/.test(pw)) s++;
  return s; // 0..5
}
function renderMeter(pw){
  const bar=$('#pwbar'); const msg=$('#pwmsg');
  const s=pwStrength(pw);
  const w=[0,20,40,60,80,100][s]; bar.style.width=w+'%';
  bar.className=''; bar.classList.add(s>=4?'success':s>=3?'warn':'danger');
  msg.textContent = (s>=4?'Strong':'Add numbers, case, symbols for strength');
}

/*** Register ***/
$('#r_show').addEventListener('change',e=>{
  const t=e.target.checked?'text':'password';
  $('#r_pw1').type=t; $('#r_pw2').type=t; $('#r_a1').type=t;
});
$('#r_pw1').addEventListener('input',e=>renderMeter(e.target.value));

$('#btn_register').addEventListener('click', async ()=>{
  const first=$('#r_first').value.trim();
  const last=$('#r_last').value.trim();
  const email=$('#r_email').value.trim().toLowerCase();
  const dob=$('#r_dob').value;
  const place=$('#r_place').value.trim();
  const country=$('#r_country').value.trim();
  const pw1=$('#r_pw1').value, pw2=$('#r_pw2').value;
  const q = ($('#r_q1').value==='Custom (type below)') ? ($('#r_q1c').value.trim()||'Custom Question') : $('#r_q1').value;
  const a = $('#r_a1').value;
  const terms=$('#r_terms').checked;
  const out=$('#r_status');

  if(!terms){ out.textContent='Please accept the terms.'; return; }
  if(!first||!last||!email||!dob||!pw1||!a){ out.textContent='Fill all required fields.'; return; }
  if(pw1!==pw2){ out.textContent='Passwords do not match.'; return; }
  if(pwStrength(pw1)<3){ out.textContent='Use a stronger password (mix case, numbers, symbol).'; return; }

  const users=read(USERS_K,{});
  if(users[email]){ out.textContent='An account with this email already exists.'; return; }

  const rec={
    first,last,email,dob,place,country,
    pw: await hash(pw1),
    q1:q, a1: await hash(a),
    created: now()
  };
  users[email]=rec; save(USERS_K,users);
  out.textContent='✅ Account created. You can sign in on the right.';
});

/*** Login (with simple lockout) ***/
$('#l_show').addEventListener('change',e=>$('#l_pw').type=e.target.checked?'text':'password');

$('#btn_login').addEventListener('click', async ()=>{
  const email=$('#l_email').value.trim().toLowerCase();
  const pw=$('#l_pw').value;
  const remember=$('#l_rem').checked;
  const out=$('#l_status');

  const locks=read(LOCK_K,{}); if(locks[email] && locks[email]>now()){
    const secs=Math.ceil((locks[email]-now())/1000);
    out.textContent='Locked for too many attempts. Try again in ~'+secs+'s.'; return;
  }

  const users=read(USERS_K,{});
  const u=users[email];
  if(!u){ out.textContent='No account found for that email.'; return; }

  const ok = (await hash(pw))===u.pw;
  if(!ok){
    const fails=read(FAILS_K,{});
    fails[email]=(fails[email]||0)+1; save(FAILS_K,fails);
    out.textContent='Incorrect password.';
    if(fails[email]>=5){ // lock 3 minutes
      const locks=read(LOCK_K,{}); locks[email]=now()+3*60*1000; save(LOCK_K,locks);
      out.textContent='Too many attempts. Locked for 3 minutes.';
    }
    return;
  }

  // success
  save(FAILS_K,Object.assign(read(FAILS_K,{}),{[email]:0}));
  const token = Math.random().toString(36).slice(2)+'.'+Date.now();
  const sess = { email, token, ts: now(), remember };
  if(remember) localStorage.setItem(SESS_K, JSON.stringify(sess));
  else sessionStorage.setItem(SESS_K, JSON.stringify(sess));

  $('#l_status').textContent='✅ Logged in. Redirecting…';
  await sleep(400);
  location.href='index.html';
});

/*** Forgot password flow ***/
$('#link_forgot').addEventListener('click',()=>document.querySelector('main').scrollTo({top:1000,behavior:'smooth'}));

$('#btn_fq').addEventListener('click',()=>{
  const email=$('#f_email').value.trim().toLowerCase();
  const users=read(USERS_K,{});
  const u=users[email];
  if(!u){ $('#f_status').textContent='No account found.'; return; }
  $('#fq_box').style.display='block';
  $('#fq_text').textContent='Security question: '+u.q1;
  $('#f_status').textContent='';
});

$('#btn_reset').addEventListener('click', async ()=>{
  const email=$('#f_email').value.trim().toLowerCase();
  const ans=$('#fq_answer').value;
  const n1=$('#fq_new1').value, n2=$('#fq_new2').value;
  const out=$('#f_status');
  const users=read(USERS_K,{});
  const u=users[email]; if(!u){ out.textContent='No account.'; return; }

  if((await hash(ans))!==u.a1){ out.textContent='Answer incorrect.'; return; }
  if(n1!==n2){ out.textContent='New passwords do not match.'; return; }
  if(pwStrength(n1)<3){ out.textContent='Choose a stronger new password.'; return; }

  u.pw = await hash(n1); users[email]=u; save(USERS_K,users);
  out.textContent='✅ Password updated. You can sign in now.';
});
</script>
</body>
</html>